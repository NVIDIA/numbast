name: "Numbast Docs Build/Upload"
description: "Builds the Numbast docs and uploads them as workflow artifacts."
inputs:
  upload_workflow_artifact:
    description: "Uploads the built docs as a workflow artifact (actions/upload-artifact)."
    required: false
    default: "true"
runs:
  using: "composite"
  steps:
    # Install required dependencies
    - name: Install docs build dependencies
      shell: bash --noprofile --norc -euo pipefail {0}
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build python3-venv git flex bison
    # Setup Python and install Python deps needed for Sphinx build
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install Python dependencies for docs
      shell: bash --noprofile --norc -euo pipefail {0}
      run: |
        python -m pip install --upgrade pip
        # Install Numbast and docs dependencies
        ast_canopy/build.sh
        python -m pip install numbast/
        python -m pip install sphinx nvidia-sphinx-theme sphinx-copybutton
    # Build all docs
    - name: Build all docs
      shell: bash --noprofile --norc -euo pipefail {0}
      run: ci/build_docs.sh
    # Copy all docs to the right folder
    - name: Move docs to right folder
      shell: bash --noprofile --norc -euo pipefail {0}
      run: |
        mkdir -p _site
        cp -rf ./docs/build/html/* _site/
        touch _site/.nojekyll
    # Update docs as workflow artifact:
    - name: Upload artifact
      if: ${{ inputs.upload_workflow_artifact == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: docs
        path: _site/
        compression-level: 0
