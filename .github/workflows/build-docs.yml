name: Deploy Numbast Documentation
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      destination_dir:
        description: "Destination directory for deployment"
        required: false
        default: "docs"
        type: string
      pr_number:
        description: "PR number for preview URL generation"
        required: false
        default: ""
        type: string
      remove_pr_preview:
        description: "If true, deploy empty folder to remove PR preview"
        required: false
        default: false
        type: boolean
      is_release:
        description: "If true, deploy to docs root. If false, deploy PR preview."
        required: false
        default: true
        type: boolean
      download_artifacts:
        description: "If true, try to download built wheel artifacts before docs build."
        required: false
        default: false
        type: boolean
  # Reusable workflow for PR previews
  workflow_call:
    inputs:
      destination_dir:
        description: "Destination directory for deployment"
        required: false
        default: "docs"
        type: string
      pr_number:
        description: "PR number for preview URL generation"
        required: false
        default: ""
        type: string
      remove_pr_preview:
        description: "If true, deploy empty folder to remove PR preview"
        required: false
        default: false
        type: boolean
      is_release:
        description: "If true, deploy to docs root. If false, deploy PR preview."
        required: false
        default: false
        type: boolean
      download_artifacts:
        description: "If true, try to download built wheel artifacts before docs build."
        required: false
        default: false
        type: boolean
    outputs:
      preview_url:
        description: "The URL where the PR preview is deployed"
        value: ${{ jobs.build-and-deploy.outputs.preview_url }}
# Sets permissions of the GITHUB_TOKEN to allow GitHub Pages deployment and PR comments
permissions:
  actions: read
  contents: write
  pull-requests: write
  pages: write
# Serialize deploy/cleanup for same PR to prevent races
concurrency:
  group: ${{ inputs.pr_number && format('pr-preview-{0}', inputs.pr_number) || 'pages-main' }}
  cancel-in-progress: false
jobs:
  # Build and deploy job
  build-and-deploy:
    runs-on: ${{ github.repository == 'NVIDIA/numbast' && 'linux-amd64-cpu32' || 'ubuntu-latest' }}
    container:
      image: condaforge/miniforge3:latest
    outputs:
      preview_url: ${{ steps.set-preview-url.outputs.preview_url }}
    steps:
      - name: Normalize PR number
        id: normalize-pr-number
        run: |
          raw_pr_number="${{ inputs.pr_number }}"
          if [ -z "${raw_pr_number}" ] && [ "${{ inputs.is_release }}" != "true" ]; then
            raw_pr_number="${GITHUB_REF_NAME}"
          fi
          if echo "${raw_pr_number}" | grep -qE '^pull-request/[0-9]+$'; then
            raw_pr_number="${raw_pr_number#pull-request/}"
          fi
          echo "pr_number=${raw_pr_number}" >> $GITHUB_OUTPUT
      - name: Validate inputs
        run: |
          normalized_pr_number="${{ steps.normalize-pr-number.outputs.pr_number }}"
          if [ "${{ inputs.remove_pr_preview }}" = "true" ] && [ -z "${normalized_pr_number}" ]; then
            echo "Error: remove_pr_preview requires pr_number to be set"
            exit 1
          fi
          if [ "${{ inputs.is_release }}" != "true" ] && [ "${{ inputs.remove_pr_preview }}" != "true" ] && [ -z "${normalized_pr_number}" ]; then
            echo "Error: PR preview deployment requires pr_number when is_release is false"
            exit 1
          fi
          if [ -n "${normalized_pr_number}" ] && ! echo "${normalized_pr_number}" | grep -qE '^[0-9]+$'; then
            echo "Error: pr_number must be numeric (got: '${normalized_pr_number}')"
            exit 1
          fi
      - name: Set preview URL
        id: set-preview-url
        run: |
          normalized_pr_number="${{ steps.normalize-pr-number.outputs.pr_number }}"
          if [ -n "${normalized_pr_number}" ]; then
            echo "preview_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/pr-${normalized_pr_number}/" >> $GITHUB_OUTPUT
          else
            echo "preview_url=" >> $GITHUB_OUTPUT
          fi
      - name: Checkout
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Build docs
        if: ${{ !inputs.remove_pr_preview }}
        uses: ./.github/actions/docs-build
        with:
          upload_workflow_artifact: "true"
          latest_only: "true"
          download_artifacts: ${{ inputs.download_artifacts && 'true' || 'false' }}
      - name: Create empty directory for cleanup
        if: ${{ inputs.remove_pr_preview }}
        run: |
          mkdir -p _site
          echo "# Preview Removed" > _site/README.md
          echo "This PR preview has been removed because the pull request was closed." >> _site/README.md
      - name: Set commit message
        id: commit-msg
        run: |
          normalized_pr_number="${{ steps.normalize-pr-number.outputs.pr_number }}"
          if [ "${{ inputs.remove_pr_preview }}" = "true" ]; then
            echo "message=Clean up doc preview for PR ${normalized_pr_number} (${{ github.sha }})" >> $GITHUB_OUTPUT
          elif [ -n "${normalized_pr_number}" ]; then
            echo "message=Deploy doc preview for PR ${normalized_pr_number} (${{ github.sha }})" >> $GITHUB_OUTPUT
          else
            echo "message=Deploy main docs (${{ github.sha }})" >> $GITHUB_OUTPUT
          fi
      - name: Deploy .nojekyll to docs root
        if: ${{ inputs.is_release && !inputs.remove_pr_preview }} # Only create .nojekyll for main docs deployment
        run: |
          mkdir -p _nojekyll
          touch _nojekyll/.nojekyll
      - name: Ensure Jekyll is disabled for GitHub Pages
        if: ${{ inputs.is_release && !inputs.remove_pr_preview }} # Only deploy .nojekyll for main docs, not PR previews
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_nojekyll
          publish_branch: gh-pages
          destination_dir: docs
          keep_files: true
          commit_message: "Deploy .nojekyll to disable Jekyll processing"
      - name: Deploy PR preview to GitHub Pages
        if: ${{ !inputs.is_release && !inputs.remove_pr_preview && steps.normalize-pr-number.outputs.pr_number }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
          destination_dir: pr-preview/pr-${{ steps.normalize-pr-number.outputs.pr_number }}
          keep_files: true
          commit_message: ${{ steps.commit-msg.outputs.message }}
      - name: Comment PR with preview URL
        if: ${{ !inputs.is_release && !inputs.remove_pr_preview && steps.normalize-pr-number.outputs.pr_number }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-preview
          number: ${{ steps.normalize-pr-number.outputs.pr_number }}
          skip_unchanged: true
          message: |
            Doc Preview CI
            :---:
            | :rocket: View pre-built docs at
            | https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/pr-${{ steps.normalize-pr-number.outputs.pr_number }}/
            | <br>Preview will be ready when GitHub Pages deployment finishes.
      - name: Deploy to GitHub Pages
        if: ${{ inputs.is_release && !inputs.remove_pr_preview }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: gh-pages
          destination_dir: ${{ inputs.destination_dir || 'docs' }}
          keep_files: true
          commit_message: ${{ steps.commit-msg.outputs.message }}
